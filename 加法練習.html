<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>åŠ æ³•ç·´ç¿’</title>
    <!-- å¼•å…¥Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <!-- å¼•å…¥Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css">
    <!-- è¨­å®šviewportï¼Œç¦ç”¨ç¸®æ”¾ -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- è‡ªè¨‚æ¨£å¼ -->
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            position: relative;
        }
        body::before {
            content: "";    
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('background.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            filter: saturate(100%) brightness(100%);
            opacity: 1.0;
            z-index: -1;
        }
        body::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: -1;
        }
        #app {
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 20px;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        #quiz {
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: space-between;
        }
        .quiz-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .question-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            margin-bottom: 10px; /* ç¸®çŸ­é¡Œç›®ä¹‹é–“çš„é–“éš™ */
        }
        .keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .keyboard button {
            padding: 15px;
            font-size: 24px;
            border-radius: 10px;
        }
        #answerInput {
            font-size: 20px;
            text-align: center;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .timer-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            flex-wrap: nowrap;
        }
        #feedback {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-weight: bold;
        }
        #progressBarContainer {
            height: 10px;
            background-color: #e9ecef;
            width: 100%;
            position: fixed;
            bottom: 0;
            left: 0;
        }
        #progressBar {
            height: 100%;
            background-color: #007bff;
            transition: width 0.5s ease-in-out;
        }
        /* Mac é¢¨æ ¼æ»¾å‹•æ¢ */
        ::-webkit-scrollbar {
            width: 9px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        @media (max-width: 767px) {
            #questionText {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            #questionText .question-number {
                margin-bottom: 10px;
            }
            #quiz .card {
                height: auto;
                margin: auto 0;
            }
            #quiz .container {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                min-height: 100vh;
            }
            .timer-info {
                font-size: 14px;
            }
            #feedback {
                font-size: 12px;
            }
            .card-body {
                padding: 1rem;
            }
            #questionText .question-number::after {
                content: none;
            }
        }
        #restartButton {
            margin-top: 20px;
        }
        .vertical-addition {
            text-align: center; /* ç½®ä¸­é¡¯ç¤º */
        }
        .back-button {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 50px;
            background-color: white;
            color: #007bff;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background-color: #f8f9fa;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .back-button i {
            margin-right: 5px;
        }

        @media (max-width: 767px) {
            .back-button {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
        /* åœ¨ç¾æœ‰çš„æ¨£å¼å¾Œæ·»åŠ ä»¥ä¸‹å…§å®¹ */
        #leaderboard {
            font-size: 1.1em;
        }
        #leaderboard th, #leaderboard td {
            text-align: center;
            vertical-align: middle;
        }
        #leaderboard th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        #leaderboard tr:nth-child(1) td {
            font-size: 1.2em;
            font-weight: bold;
        }
        #leaderboard tr:nth-child(2) td {
            font-size: 1.1em;
        }
        #leaderboard tr:nth-child(3) td {
            font-size: 1.05em;
        }
        #leaderboard td:nth-child(2),
        #leaderboard td:nth-child(3) {
            color: black;
        }
        @media (max-width: 576px) {
            #leaderboard {
                font-size: 0.9em;
            }
            #leaderboard th, #leaderboard td {
                padding: 0.5rem;
            }
        }
        /* åœ¨ç¾æœ‰çš„æ¨£å¼å¾Œæ·»åŠ ä»¥ä¸‹å…§å®¹ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .countdown-number {
            font-size: 10rem;
            color: white;
        }
        .penalty-time {
            color: red;
            font-weight: bold;
            margin-left: 10px;
        }
    </style>
    <!-- æ·»åŠ MathJaxæ”¯æŒ -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
<div id="app">
    <!-- ä¿®æ”¹è¨­å®šæ¡†éƒ¨åˆ† -->
    <div id="setup" class="container">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title text-center">åŠ æ³•ç·´ç¿’</h2>
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>åŠ æ³•ä½æ•¸ï¼š</label>
                            <div class="d-flex">
                                <select id="firstNumber" class="form-control mr-2">
                                    <option value="1">1ä½æ•¸</option>
                                    <option value="2" selected>2ä½æ•¸</option>
                                    <option value="3">3ä½æ•¸</option>
                                </select>
                                <span class="align-self-center">+</span>
                                <select id="secondNumber" class="form-control ml-2">
                                    <option value="1">1ä½æ•¸</option>
                                    <option value="2" selected>2ä½æ•¸</option>
                                    <option value="3">3ä½æ•¸</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="questionCount">é¡Œæ•¸ï¼š</label>
                            <input type="number" id="questionCount" class="form-control" value="10" min="1">
                        </div>
                        <div class="form-group">
                            <label for="timePerQuestion">æ¯é¡Œæ™‚é–“ï¼ˆç§’ï¼‰ï¼š</label>
                            <select id="timePerQuestion" class="form-control">
                                <option value="5">5 ç§’</option>
                                <option value="10">10 ç§’</option>
                                <option value="15" selected>15 ç§’</option>
                                <option value="20">20 ç§’</option>
                                <option value="25">25 ç§’</option>
                                <option value="30">30 ç§’</option>
                                <option value="timer">è¨ˆæ™‚æ¨¡å¼</option>
                            </select>
                        </div>
                        <div class="text-center">
                            <button id="startButton" class="btn btn-primary" style="width: 50%;">é–‹å§‹ç·´ç¿’</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¤‡ç¿’å°ˆå€ -->
        <div class="card mt-4 review-card">
            <div class="card-body">
                <h3 class="card-title">è¤‡ç¿’å°ˆå€</h3>
                <p>åŠ æ³•é‹ç®—æŠ€å·§ï¼š</p>
                <ul>
                    <li>å¾å€‹ä½æ•¸é–‹å§‹è¨ˆç®—ï¼Œé€ä½å‘å·¦é€²è¡Œ</li>
                    <li>æ³¨æ„é€²ä½ï¼Œæ¯ç•¶ä¸€ä½çš„å’Œå¤§æ–¼æˆ–ç­‰æ–¼10æ™‚ï¼Œè¦å‘å·¦é€²ä½</li>
                    <li>æœ€å¾Œä¸€ä½ï¼ˆæœ€å·¦é‚Šï¼‰å¦‚æœæœ‰é€²ä½ï¼Œè¦åœ¨æœ€å‰é¢åŠ 1</li>
                </ul>
                <p>ç·´ç¿’æç¤ºï¼š</p>
                <ul>
                    <li>å…ˆè¨ˆç®—å€‹ä½æ•¸çš„å’Œï¼Œå†è¨ˆç®—åä½æ•¸ï¼Œæœ€å¾Œè¨ˆç®—ç™¾ä½æ•¸</li>
                    <li>è¨˜ä½é€²ä½çš„æ•¸å­—ï¼ŒåŠ åˆ°ä¸‹ä¸€ä½çš„è¨ˆç®—ä¸­</li>
                    <li>æª¢æŸ¥æœ€çµ‚ç­”æ¡ˆçš„ä½æ•¸æ˜¯å¦æ­£ç¢º</li>
                </ul>
            </div>
        </div>
        <!-- ä¿®æ”¹æ’è¡Œæ¦œå¡ç‰‡ -->
        <div class="card mt-4 leaderboard-card">
            <div class="card-body">
                <div id="challengeMessage"></div>
                <div class="text-center mb-3">
                    <img id="challengeButton" src="icons/challenge.gif" alt="æŒ‘æˆ°æ¨¡å¼" style="width: 200px; height: 100px; cursor: pointer;">
                </div>
                <h3 class="card-title">ğŸ† æ’è¡Œæ¦œ</h3>
                <table id="leaderboard" class="table table-striped">
                    <thead>
                        <tr>
                            <th>åæ¬¡</th>
                            <th>å§“å</th>
                            <th>ç§’æ•¸</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- æ’è¡Œæ¦œå…§å®¹å°‡é€šé JavaScript å‹•æ…‹å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="quiz" class="container" style="display: none;">
        <button id="backButton" class="btn back-button">
            <i class="fas fa-arrow-left"></i> é‡æ–°ä¾†é
        </button>
        <div class="quiz-content">
            <div class="card">
                <div class="card-body">
                    <div class="timer-info">
                        <span class="timer">å‰©é¤˜æ™‚é–“ï¼š<span id="timeLeft"></span> ç§’</span>
                        <span id="feedback"></span>
                        <span>å‰©é¤˜é¡Œæ•¸ï¼š<span id="questionsLeft"></span></span>
                    </div>
                    <div class="question-container">
                        <h3 class="question" id="questionText"></h3>
                        <input type="text" id="answerInput" class="form-control" readonly autocomplete="off" inputmode="numeric">
                    </div>
                    <div class="keyboard" id="keyboard">
                        <button class="btn btn-light" data-value="7">7</button>
                        <button class="btn btn-light" data-value="8">8</button>
                        <button class="btn btn-light" data-value="9">9</button>
                        <button class="btn btn-light" data-value="4">4</button>
                        <button class="btn btn-light" data-value="5">5</button>
                        <button class="btn btn-light" data-value="6">6</button>
                        <button class="btn btn-light" data-value="1">1</button>
                        <button class="btn btn-light" data-value="2">2</button>
                        <button class="btn btn-light" data-value="3">3</button>
                        <button class="btn btn-light" data-value="0">0</button>
                        <button class="btn btn-warning" id="deleteButton"><i class="fas fa-backspace"></i></button>
                        <button class="btn btn-success" id="submitButton"><i class="fas fa-check"></i></button>
                    </div>
                </div>
            </div>
        </div>
        <div id="progressBarContainer">
            <div id="progressBar"></div>
        </div>
    </div>

    <div id="result" class="container" style="display: none;">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title">ç·´ç¿’çµæŸï¼</h2>
                <p>ä½ çš„å¾—åˆ†ï¼š<span id="score"></span>/<span id="totalQuestions"></span></p>
                <div id="questionList"></div>
                <button id="restartButton" class="btn btn-primary">å†è©¦ä¸€æ¬¡</button>
            </div>
        </div>
    </div>

    <!-- åœ¨ <div id="app"> å…§éƒ¨ï¼Œæ·»åŠ ä»¥ä¸‹å…§å®¹ -->
    <div id="countdown" class="countdown-overlay" style="display: none;">
        <div class="countdown-number"></div>
    </div>

    <!-- åœ¨ <div id="app"> å…§éƒ¨ï¼Œæ·»åŠ ä»¥ä¸‹å…§å®¹ -->
    <div id="confirmDialog" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¢ºèªé‡æ–°é–‹å§‹</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿç•¶å‰é€²åº¦å°‡æœƒä¸Ÿå¤±ã€‚</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="confirmRestart">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¼•å…¥jQueryå’ŒBootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<!-- è‡ªè¨‚è…³æœ¬ -->
<script>
$(document).ready(function() {
    // ä¿è¼‰æ™‚åˆ°é ‚éƒ¨
    window.scrollTo(0, 0);

    let questionCount = 10;
    let timePerQuestion = 15;
    let questions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let timer;
    let userAnswers = [];
    let isTimerMode = false;
    let startTime;
    let totalTime;

    // æ·»åŠ æ–°çš„å…¨å±€è®Šé‡
    let playerName = '';

    let isChallenge = false;

    let penaltyTime = 0;

    // æ·»åŠ æ¿€å‹µæ–‡å­—
    const challengeMessage = "ä½ æº–å‚™å¥½æ¥å—æŒ‘æˆ°äº†å—ï¼Ÿ\né»æ“Šä¸‹æ–¹åœ–ç‰‡é–‹å§‹æŒ‘æˆ°æ¨¡å¼ï¼";
    $('#challengeMessage').html(`<p class="text-center font-weight-bold mb-3">${challengeMessage.replace('\n', '<br>')}</p>`);

    // ä¿®æ”¹æŒ‘æˆ°æŒ‰éˆ•äº‹ä»¶
    $('#challengeButton').click(function() {
        isChallenge = true;
        startChallenge();
    });

    // ä¿®æ”¹ startChallenge å‡½æ•¸
    function startChallenge() {
        $('#firstNumber').val('3');
        $('#secondNumber').val('3');
        $('#questionCount').val('10');
        $('#timePerQuestion').val('timer');
        isTimerMode = true;
        isChallenge = true;
        questionCount = 10;
        penaltyTime = 0;

        generateQuestions(3, 3);
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = [];

        $('#setup').hide();
        startCountdown();
    }

    // æ·»åŠ å€’æ•¸è¨ˆæ™‚å‡½æ•¸
    function startCountdown() {
        let count = 3;
        $('#countdown').show();
        $('.countdown-number').text(count);
        const countdownInterval = setInterval(() => {
            count--;
            if (count > 0) {
                $('.countdown-number').text(count);
            } else if (count === 0) {
                $('.countdown-number').text('é–‹å§‹ï¼');
            } else {
                clearInterval(countdownInterval);
                $('#countdown').hide();
                startQuiz();
            }
        }, 1000);
    }

    // æ·»åŠ é–‹å§‹æ¸¬é©—å‡½æ•¸
    function startQuiz() {
        startTime = new Date().getTime();
        $('.timer').text('å·²ç”¨æ™‚é–“ï¼š0.000 ç§’');
        $('#quiz').show();
        showQuestion();
    }

    // æ·»åŠ ç²å–æ’è¡Œæ¦œæ•¸æ“šçš„å‡½æ•¸
    function fetchLeaderboard() {
        $.ajax({
            url: 'https://rainbowstudent.wentzao.com/gamechart',
            method: 'GET',
            data: { game: 'åŠ æ³•ç·´ç¿’', mode: 'æŒ‘æˆ°æ¨¡å¼', limit: 10 },
            success: function(data) {
                displayLeaderboard(data);
            },
            error: function(error) {
                console.error('Error fetching leaderboard:', error);
                displayLeaderboard([]); // é¡¯ç¤ºç©ºçš„æ’è¡Œæ¦œ
            }
        });
    }

    // æ·»åŠ é¡¯ç¤ºæ’è¡Œæ¦œçš„å‡½æ•¸
    function displayLeaderboard(data) {
        let leaderboardHtml = '';
        for (let i = 0; i < 10; i++) {
            if (i < data.length) {
                leaderboardHtml += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${data[i].name}</td>
                        <td>${parseFloat(data[i].time).toFixed(3)} (${data[i].score})</td>
                    </tr>
                `;
            } else {
                leaderboardHtml += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                `;
            }
        }
        $('#leaderboard tbody').html(leaderboardHtml);
    }

    $('#startButton').click(function() {
        isChallenge = false;
        isTimerMode = ($('#timePerQuestion').val() === 'timer');
        let firstNumberDigits = parseInt($('#firstNumber').val());
        let secondNumberDigits = parseInt($('#secondNumber').val());
        questionCount = parseInt($('#questionCount').val());
        timePerQuestion = $('#timePerQuestion').val();
        isTimerMode = (timePerQuestion === 'timer');

        if (isTimerMode) {
            startTime = new Date().getTime();
            $('.timer').text('å·²ç”¨æ™‚é–“ï¼š0.000 ç§’');
        } else {
            timePerQuestion = parseInt(timePerQuestion);
        }

        generateQuestions(firstNumberDigits, secondNumberDigits);
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = [];

        $('#setup').hide();
        $('#quiz').show();
        showQuestion();

        // åœ¨ $('#startButton').click å‡½æ•¸ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç¢¼ä¾†é‡ç½®ç©å®¶åç¨±
        playerName = '';
    });

    function generateQuestions(firstNumberDigits, secondNumberDigits) {
        questions = [];
        let usedQuestions = new Set();
        while (questions.length < questionCount) {
            let num1 = generateRandomNumber(firstNumberDigits);
            let num2 = generateRandomNumber(secondNumberDigits);
            let questionKey = `${num1}+${num2}`;
            if (!usedQuestions.has(questionKey)) {
                let answer = num1 + num2;
                questions.push({
                    num1: num1,
                    num2: num2,
                    answer: answer
                });
                usedQuestions.add(questionKey);
            }
        }
    }

    function generateRandomNumber(digits) {
        let min = Math.pow(10, digits - 1);
        let max = Math.pow(10, digits) - 1;
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function showQuestion() {
        if (currentQuestionIndex >= questions.length) {
            endQuiz();
            return;
        }

        let currentQuestion = questions[currentQuestionIndex];
        $('#questionText').html('<span class="question-number">ç¬¬ ' + (currentQuestionIndex + 1) + ' é¡Œï¼š</span><span>' + currentQuestion.num1 + ' + ' + currentQuestion.num2 + ' = ?</span>');
        $('#answerInput').val('').prop('readonly', false);  // æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦å•Ÿç”¨
        $('#timeLeft').text(timePerQuestion);
        $('#questionsLeft').text(questions.length - currentQuestionIndex);
        $('#keyboard').show();
        $('#feedback').text('');

        updateProgressBar();

        $('#answerInput').focus();

        clearInterval(timer);
        if (isTimerMode) {
            updateTimer();
            timer = setInterval(updateTimer, 10); // æ¯10æ¯«ç§’æ›´æ–°ä¸€æ¬¡
        } else {
            let timeLeft = timePerQuestion;
            timer = setInterval(function() {
                timeLeft--;
                $('#timeLeft').text(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    checkAnswer(true);
                }
            }, 1000);
        }
    }

    function updateProgressBar() {
        let progress = (currentQuestionIndex / questions.length) * 100;
        $('#progressBar').css('width', progress + '%');
    }

    $('#answerInput').focus(function() {
        $('#keyboard').show();
    });

    $('#keyboard button').not('#deleteButton, #submitButton').click(function() {
        let num = $(this).data('value');
        let currentVal = $('#answerInput').val();
        $('#answerInput').val(currentVal + num);
    });

    $('#deleteButton').click(function() {
        let currentVal = $('#answerInput').val();
        $('#answerInput').val(currentVal.slice(0, -1));
    });

    $('#submitButton').click(function() {
        checkAnswer();
    });

    function checkAnswer(timeUp = false) {
        clearInterval(timer);
        let userAnswer = parseInt($('#answerInput').val());
        let correctAnswer = questions[currentQuestionIndex].answer;
        $('#answerInput').prop('readonly', true);
        if (userAnswer === correctAnswer) {
            score++;
            $('#feedback').html('<span class="text-success">æ­£ç¢ºï¼</span>');
        } else {
            if (timeUp) {
                $('#feedback').html('<span class="text-danger">æ™‚é–“åˆ°ï¼</span>');
            } else {
                $('#feedback').html('<span class="text-danger">éŒ¯èª¤ï¼</span>');
            }
            if (isChallenge) {
                penaltyTime += 15;
            }
        }
        userAnswers.push({
            num1: questions[currentQuestionIndex].num1,
            num2: questions[currentQuestionIndex].num2,
            correctAnswer: correctAnswer,
            userAnswer: userAnswer,
            isCorrect: (userAnswer === correctAnswer)
        });
        currentQuestionIndex++;
        setTimeout(showQuestion, 500);  // ç¸®çŸ­åˆ°0.5ç§’

        if (isTimerMode && currentQuestionIndex >= questions.length) {
            totalTime = new Date().getTime() - startTime + penaltyTime * 1000;
        }
    }

    function updateTimer() {
        let currentTime = new Date().getTime();
        let elapsedTime = currentTime - startTime;
        let seconds = Math.floor(elapsedTime / 1000);
        let milliseconds = elapsedTime % 1000;
        $('.timer').html('å·²ç”¨æ™‚é–“ï¼š' + seconds + '.' + milliseconds.toString().padStart(3, '0') + ' ç§’' +
            (penaltyTime > 0 ? '<span class="penalty-time">(+' + penaltyTime + 'ç§’)</span>' : ''));
    }

    function getVerticalAddition(num1, num2) {
        let maxLength = Math.max(num1.toString().length, num2.toString().length);
        let sum = num1 + num2;
        let carry = 0;
        let carryLine = '';

        for (let i = 0; i < maxLength; i++) {
            let digit1 = Math.floor(num1 / Math.pow(10, i)) % 10;
            let digit2 = Math.floor(num2 / Math.pow(10, i)) % 10;
            let digitSum = digit1 + digit2 + carry;
            carry = Math.floor(digitSum / 10);
            if (carry > 0) {
                carryLine = '\\small{' + carry + '}\\phantom{0}' + carryLine;
            } else {
                carryLine = '\\phantom{\\small{0}}\\phantom{0}' + carryLine;
            }
        }

        let latex = '\\large{\\begin{array}{r}';
        latex += `${carryLine} \\\\[-.7em]`;
        latex += `${num1.toString().padStart(maxLength, '\\phantom{0}')} \\\\`;
        latex += `+ ${num2.toString().padStart(maxLength, '\\phantom{0}')} \\\\`;
        latex += '\\hline ';
        latex += `${sum} \\\\`;
        latex += '\\end{array}}';

        return latex;
    }

    // ä¿®æ”¹ endQuiz å‡½æ•¸
    function endQuiz() {
        $('#quiz').hide();
        $('#progressBar').css('width', '100%');
        $('#result').show();
        
        // æ¸…ç©ºä¹‹å‰çš„çµæœ
        $('#result .card-body').empty();
        
        // æ·»åŠ æ¨™é¡Œ
        $('#result .card-body').append('<h2 class="card-title">ç·´ç¿’çµæŸï¼</h2>');
        
        // æ·»åŠ å¾—åˆ†
        $('#result .card-body').append('<p>ä½ çš„å¾—åˆ†ï¼š<span id="score">' + score + '</span>/<span id="totalQuestions">' + questions.length + '</span></p>');

        let totalTimeInSeconds = (totalTime - penaltyTime * 1000) / 1000;
        let competitionTimeInSeconds = totalTime / 1000;

        // åœ¨åŒä¸€è¡Œé¡¯ç¤ºç¸½ç”¨æ™‚å’Œæ¯”è³½æ™‚é–“
        $('#result .card-body').append(
            '<p>ç¸½ç”¨æ™‚ï¼š' + totalTimeInSeconds.toFixed(3) + ' ç§’ | æ¯”è³½æ™‚é–“ï¼š' + competitionTimeInSeconds.toFixed(3) + ' ç§’ ' +
            (penaltyTime > 0 ? '(åŒ…å« ' + penaltyTime + ' ç§’æ‡²ç½°æ™‚é–“)' : '') + '</p>'
        );

        if (isChallenge) {
            $('#finalTime').text(competitionTimeInSeconds.toFixed(3));
            $('#nameInputModal').modal('show');
        }

        // æ·»åŠ é¡Œç›®åˆ—è¡¨
        let questionListHtml = '<h3>é¡Œç›®åˆ—è¡¨ï¼š</h3><ul class="list-group">';
        for (let i = 0; i < userAnswers.length; i++) {
            let q = userAnswers[i];
            let listItemClass = q.isCorrect ? 'list-group-item list-group-item-success' : 'list-group-item list-group-item-danger';
            questionListHtml += '<li class="' + listItemClass + '">';
            questionListHtml += 'é¡Œç›® ' + (i + 1) + 'ï¼š' + q.num1 + ' + ' + q.num2 + ' = ' + q.correctAnswer + '<br>';
            questionListHtml += 'ä½ çš„ç­”æ¡ˆï¼š' + q.userAnswer + '<br>';
            questionListHtml += 'ç›´å¼è¨ˆç®—ï¼š<br>';
            questionListHtml += '<div class="vertical-addition">\\[' + getVerticalAddition(q.num1, q.num2) + '\\]</div>';
            questionListHtml += '</li>';
        }
        questionListHtml += '</ul>';
        $('#result .card-body').append(questionListHtml);

        // æ·»åŠ é‡æ–°é–‹å§‹æŒ‰éˆ•
        $('#result .card-body').append('<button id="restartButton" class="btn btn-primary">å†è©¦ä¸€æ¬¡</button>');

        // é‡æ–°ç¶å®šé‡æ–°é–‹å§‹æŒ‰éˆ•çš„äº‹ä»¶
        $('#restartButton').click(function() {
            isChallenge = false;
            $('#result').hide();
            $('#progressBar').css('width', '0%');
            $('#setup').show();
            window.scrollTo(0, 0);
        });

        MathJax.typeset();
    }

    // ä¿®æ”¹æäº¤æˆç¸¾æŒ‰éˆ•äº‹ä»¶
    $('#submitScoreBtn').click(function() {
        playerName = $('#playerNameInput').val().trim();
        if (playerName) {
            submitScore(totalTime / 1000);
            $('#nameInputModal').modal('hide');
        } else {
            alert('è«‹è¼¸å…¥ä½ çš„åå­—ï¼');
        }
    });

    // ä¿®æ”¹æäº¤æˆç¸¾çš„å‡½æ•¸
    function submitScore(time) {
        $.ajax({
            url: 'https://rainbowstudent.wentzao.com/gamechart',
            method: 'POST',
            data: {
                game: 'åŠ æ³•ç·´ç¿’',
                mode: 'æŒ‘æˆ°æ¨¡å¼',
                name: playerName,
                time: time.toFixed(3),
                score: score + '/' + questionCount
            },
            success: function(response) {
                alert('æˆç¸¾æäº¤æˆåŠŸï¼');
                fetchLeaderboard(); // é‡æ–°ç²å–ä¸¦é¡¯ç¤ºæ’è¡Œæ¦œ
            },
            error: function(error) {
                console.error('Error submitting score:', error);
                alert('æˆç¸¾æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        });
    }

    $('#restartButton').click(function() {
        isChallenge = false;
        $('#result').hide();
        $('#progressBar').css('width', '0%');
        $('#setup').show();
        window.scrollTo(0, 0);
    });

    document.addEventListener('gesturestart', function(e) {
        e.preventDefault();
    });

    document.addEventListener('dblclick', function(e) {
        e.preventDefault();
    });

    $('#answerInput').on('keydown', function(e) {
        if (e.key === 'Enter') {
            checkAnswer();
        }
    });

    setInterval(function() {
        $('#answerInput').focus();
    }, 100);

    $('#backButton').click(function() {
        $('#confirmDialog').modal('show');
    });

    $('#confirmRestart').click(function() {
        isChallenge = false;
        clearInterval(timer);
        $('#quiz').hide();
        $('#setup').show();
        $('#progressBar').css('width', '0%');
        window.scrollTo(0, 0);
        $('#confirmDialog').modal('hide');
    });

    // åœ¨ document ready å‡½æ•¸çš„æœ€å¾Œæ·»åŠ ä»¥ä¸‹ä»£ç¢¼ä¾†åˆå§‹åŒ–æ’è¡Œæ¦œ
    fetchLeaderboard();
});
</script>

<!-- åœ¨ body çµæŸæ¨™ç±¤å‰æ·»åŠ ä»¥ä¸‹å…§å®¹ -->
<div class="modal fade" id="nameInputModal" tabindex="-1" role="dialog" aria-labelledby="nameInputModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nameInputModalLabel">æ­å–œå®ŒæˆæŒ‘æˆ°ï¼</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-center">ä½ çš„ç¸½ç”¨æ™‚ï¼š<span id="finalTime" class="font-weight-bold"></span> ç§’</p>
                <div class="form-group">
                    <label for="playerNameInput">è«‹è¼¸å…¥ä½ çš„åå­—ï¼š</label>
                    <input type="text" class="form-control" id="playerNameInput">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="submitScoreBtn">æäº¤æˆç¸¾</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>