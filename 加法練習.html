<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>加法練習</title>
    <!-- 引入Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <!-- 引入Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css">
    <!-- 設定viewport，禁用縮放 -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- 自訂樣式 -->
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            position: relative;
        }
        body::before {
            content: "";    
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('background.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            filter: saturate(100%) brightness(100%);
            opacity: 1.0;
            z-index: -1;
        }
        body::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: -1;
        }
        #app {
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 20px;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        #quiz {
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: space-between;
        }
        .quiz-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .question-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            margin-bottom: 10px; /* 縮短題目之間的間隙 */
        }
        .keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .keyboard button {
            padding: 15px;
            font-size: 24px;
            border-radius: 10px;
        }
        #answerInput {
            font-size: 20px;
            text-align: center;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .timer-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            flex-wrap: nowrap;
        }
        #feedback {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-weight: bold;
        }
        #progressBarContainer {
            height: 10px;
            background-color: #e9ecef;
            width: 100%;
            position: fixed;
            bottom: 0;
            left: 0;
        }
        #progressBar {
            height: 100%;
            background-color: #007bff;
            transition: width 0.5s ease-in-out;
        }
        /* Mac 風格滾動條 */
        ::-webkit-scrollbar {
            width: 9px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        @media (max-width: 767px) {
            #questionText {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            #questionText .question-number {
                margin-bottom: 10px;
            }
            #quiz .card {
                height: auto;
                margin: auto 0;
            }
            #quiz .container {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                min-height: 100vh;
            }
            .timer-info {
                font-size: 14px;
            }
            #feedback {
                font-size: 12px;
            }
            .card-body {
                padding: 1rem;
            }
            #questionText .question-number::after {
                content: none;
            }
        }
        #restartButton {
            margin-top: 20px;
        }
        .vertical-addition {
            text-align: center; /* 置中顯示 */
        }
    </style>
    <!-- 添加MathJax支持 -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
<div id="app">
    <!-- 修改設定框部分 -->
    <div id="setup" class="container">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title text-center">加法練習</h2>
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>加法位數：</label>
                            <div class="d-flex">
                                <select id="firstNumber" class="form-control mr-2">
                                    <option value="1">1位數</option>
                                    <option value="2" selected>2位數</option>
                                    <option value="3">3位數</option>
                                </select>
                                <span class="align-self-center">+</span>
                                <select id="secondNumber" class="form-control ml-2">
                                    <option value="1">1位數</option>
                                    <option value="2" selected>2位數</option>
                                    <option value="3">3位數</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="questionCount">題數：</label>
                            <input type="number" id="questionCount" class="form-control" value="10" min="1">
                        </div>
                        <div class="form-group">
                            <label for="timePerQuestion">每題時間（秒）：</label>
                            <select id="timePerQuestion" class="form-control">
                                <option value="5">5 秒</option>
                                <option value="10">10 秒</option>
                                <option value="15" selected>15 秒</option>
                                <option value="20">20 秒</option>
                                <option value="25">25 秒</option>
                                <option value="30">30 秒</option>
                                <option value="timer">計時模式</option>
                            </select>
                        </div>
                        <div class="text-center">
                            <button id="startButton" class="btn btn-primary" style="width: 50%;">開始練習</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 複習專區 -->
        <div class="card mt-4 review-card">
            <div class="card-body">
                <h3 class="card-title">複習專區</h3>
                <p>加法運算技巧：</p>
                <ul>
                    <li>從個位數開始計算，逐位向左進行</li>
                    <li>注意進位，每當一位的和大於或等於10時，要向左進位</li>
                    <li>最後一位（最左邊）如果有進位，要在最前面加1</li>
                </ul>
                <p>練習提示：</p>
                <ul>
                    <li>先計算個位數的和，再計算十位數，最後計算百位數</li>
                    <li>記住進位的數字，加到下一位的計算中</li>
                    <li>檢查最終答案的位數是否正確</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="quiz" class="container" style="display: none;">
        <div class="quiz-content">
            <div class="card">
                <div class="card-body">
                    <div class="timer-info">
                        <span class="timer">剩餘時間：<span id="timeLeft"></span> 秒</span>
                        <span id="feedback"></span>
                        <span>剩餘題數：<span id="questionsLeft"></span></span>
                    </div>
                    <div class="question-container">
                        <h3 class="question" id="questionText"></h3>
                        <input type="text" id="answerInput" class="form-control" readonly autocomplete="off" inputmode="numeric">
                    </div>
                    <div class="keyboard" id="keyboard">
                        <button class="btn btn-light" data-value="7">7</button>
                        <button class="btn btn-light" data-value="8">8</button>
                        <button class="btn btn-light" data-value="9">9</button>
                        <button class="btn btn-light" data-value="4">4</button>
                        <button class="btn btn-light" data-value="5">5</button>
                        <button class="btn btn-light" data-value="6">6</button>
                        <button class="btn btn-light" data-value="1">1</button>
                        <button class="btn btn-light" data-value="2">2</button>
                        <button class="btn btn-light" data-value="3">3</button>
                        <button class="btn btn-light" data-value="0">0</button>
                        <button class="btn btn-warning" id="deleteButton"><i class="fas fa-backspace"></i></button>
                        <button class="btn btn-success" id="submitButton"><i class="fas fa-check"></i></button>
                    </div>
                </div>
            </div>
        </div>
        <div id="progressBarContainer">
            <div id="progressBar"></div>
        </div>
    </div>

    <div id="result" class="container" style="display: none;">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title">練習結束！</h2>
                <p>你的得分：<span id="score"></span>/<span id="totalQuestions"></span></p>
                <div id="questionList"></div>
                <button id="restartButton" class="btn btn-primary">再試一次</button>
            </div>
        </div>
    </div>
</div>

<!-- 引入jQuery和Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<!-- 自訂腳本 -->
<script>
$(document).ready(function() {
    // 確保頁面載入時回到頂部
    window.scrollTo(0, 0);

    let questionCount = 10;
    let timePerQuestion = 15;
    let questions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let timer;
    let userAnswers = [];
    let isTimerMode = false;
    let startTime;
    let totalTime;

    $('#startButton').click(function() {
        let firstNumberDigits = parseInt($('#firstNumber').val());
        let secondNumberDigits = parseInt($('#secondNumber').val());
        questionCount = parseInt($('#questionCount').val());
        timePerQuestion = $('#timePerQuestion').val();
        isTimerMode = (timePerQuestion === 'timer');

        if (isTimerMode) {
            startTime = new Date().getTime();
            $('.timer').text('已用時間：0 秒');
        } else {
            timePerQuestion = parseInt(timePerQuestion);
        }

        generateQuestions(firstNumberDigits, secondNumberDigits);
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = [];

        $('#setup').hide();
        $('#quiz').show();
        showQuestion();
    });

    function generateQuestions(firstNumberDigits, secondNumberDigits) {
        questions = [];
        let usedQuestions = new Set();
        while (questions.length < questionCount) {
            let num1 = generateRandomNumber(firstNumberDigits);
            let num2 = generateRandomNumber(secondNumberDigits);
            let questionKey = `${num1}+${num2}`;
            if (!usedQuestions.has(questionKey)) {
                let answer = num1 + num2;
                questions.push({
                    num1: num1,
                    num2: num2,
                    answer: answer
                });
                usedQuestions.add(questionKey);
            }
        }
    }

    function generateRandomNumber(digits) {
        let min = Math.pow(10, digits - 1);
        let max = Math.pow(10, digits) - 1;
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function showQuestion() {
        if (currentQuestionIndex >= questions.length) {
            endQuiz();
            return;
        }

        let currentQuestion = questions[currentQuestionIndex];
        $('#questionText').html('<span class="question-number">第 ' + (currentQuestionIndex + 1) + ' 題：</span><span>' + currentQuestion.num1 + ' + ' + currentQuestion.num2 + ' = ?</span>');
        $('#answerInput').val('').prop('readonly', false);  // 清空輸入框並啟用
        $('#timeLeft').text(timePerQuestion);
        $('#questionsLeft').text(questions.length - currentQuestionIndex);
        $('#keyboard').show();
        $('#feedback').text('');

        updateProgressBar();

        $('#answerInput').focus();

        clearInterval(timer);
        if (isTimerMode) {
            updateTimer();
            timer = setInterval(updateTimer, 1000);
        } else {
            let timeLeft = timePerQuestion;
            timer = setInterval(function() {
                timeLeft--;
                $('#timeLeft').text(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    checkAnswer(true);
                }
            }, 1000);
        }
    }

    function updateProgressBar() {
        let progress = (currentQuestionIndex / questions.length) * 100;
        $('#progressBar').css('width', progress + '%');
    }

    $('#answerInput').focus(function() {
        $('#keyboard').show();
    });

    $('#keyboard button').not('#deleteButton, #submitButton').click(function() {
        let num = $(this).data('value');
        let currentVal = $('#answerInput').val();
        $('#answerInput').val(currentVal + num);
    });

    $('#deleteButton').click(function() {
        let currentVal = $('#answerInput').val();
        $('#answerInput').val(currentVal.slice(0, -1));
    });

    $('#submitButton').click(function() {
        checkAnswer();
    });

    function checkAnswer(timeUp = false) {
        clearInterval(timer);
        let userAnswer = parseInt($('#answerInput').val());
        let correctAnswer = questions[currentQuestionIndex].answer;
        $('#answerInput').prop('readonly', true);
        if (userAnswer === correctAnswer) {
            score++;
            $('#feedback').html('<span class="text-success">正確！</span>');
        } else {
            if (timeUp) {
                $('#feedback').html('<span class="text-danger">時間到！</span>');
            } else {
                $('#feedback').html('<span class="text-danger">錯誤！</span>');
            }
        }
        userAnswers.push({
            num1: questions[currentQuestionIndex].num1,
            num2: questions[currentQuestionIndex].num2,
            correctAnswer: correctAnswer,
            userAnswer: userAnswer,
            isCorrect: (userAnswer === correctAnswer)
        });
        currentQuestionIndex++;
        setTimeout(showQuestion, 500);  // 縮短到0.5秒

        if (isTimerMode && currentQuestionIndex >= questions.length) {
            totalTime = Math.floor((new Date().getTime() - startTime) / 1000);
        }
    }

    function updateTimer() {
        let currentTime = new Date().getTime();
        let elapsedTime = Math.floor((currentTime - startTime) / 1000);
        $('.timer').text('已用時間：' + elapsedTime + ' 秒');
    }

    function getVerticalAddition(num1, num2) {
        let maxLength = Math.max(num1.toString().length, num2.toString().length);
        let sum = num1 + num2;
        let carry = 0;
        let carryLine = '';

        for (let i = 0; i < maxLength; i++) {
            let digit1 = Math.floor(num1 / Math.pow(10, i)) % 10;
            let digit2 = Math.floor(num2 / Math.pow(10, i)) % 10;
            let digitSum = digit1 + digit2 + carry;
            carry = Math.floor(digitSum / 10);
            if (carry > 0) {
                carryLine = '\\small{' + carry + '}\\phantom{0}' + carryLine;
            } else {
                carryLine = '\\phantom{\\small{0}}\\phantom{0}' + carryLine;
            }
        }

        let latex = '\\large{\\begin{array}{r}';
        latex += `${carryLine} \\\\[-.7em]`;
        latex += `${num1.toString().padStart(maxLength, '\\phantom{0}')} \\\\`;
        latex += `+ ${num2.toString().padStart(maxLength, '\\phantom{0}')} \\\\`;
        latex += '\\hline ';
        latex += `${sum} \\\\`;
        latex += '\\end{array}}';

        return latex;
    }

    function endQuiz() {
        $('#quiz').hide();
        $('#progressBar').css('width', '100%');
        $('#result').show();
        $('#score').text(score);
        $('#totalQuestions').text(questions.length);

        if (isTimerMode) {
            $('#result .card-body').prepend('<p>總用時：' + totalTime + ' 秒</p>');
        }

        let questionListHtml = '<h3>題目列表：</h3><ul class="list-group">';
        for (let i = 0; i < userAnswers.length; i++) {
            let q = userAnswers[i];
            let listItemClass = q.isCorrect ? 'list-group-item list-group-item-success' : 'list-group-item list-group-item-danger';
            questionListHtml += '<li class="' + listItemClass + '">';
            questionListHtml += '題目 ' + (i + 1) + '：' + q.num1 + ' + ' + q.num2 + ' = ' + q.correctAnswer + '<br>';
            questionListHtml += '你的答案：' + q.userAnswer + '<br>';
            questionListHtml += '直式計算：<br>';
            questionListHtml += '<div class="vertical-addition">\\[' + getVerticalAddition(q.num1, q.num2) + '\\]</div>';
            questionListHtml += '</li>';
        }
        questionListHtml += '</ul>';
        $('#questionList').html(questionListHtml);
        MathJax.typeset();
    }

    $('#restartButton').click(function() {
        $('#result').hide();
        $('#progressBar').css('width', '0%');
        $('#setup').show();
        window.scrollTo(0, 0);
    });

    document.addEventListener('gesturestart', function(e) {
        e.preventDefault();
    });

    document.addEventListener('dblclick', function(e) {
        e.preventDefault();
    });

    $('#answerInput').on('keydown', function(e) {
        if (e.key === 'Enter') {
            checkAnswer();
        }
    });

    setInterval(function() {
        $('#answerInput').focus();
    }, 100);
});
</script>
</body>
</html>
